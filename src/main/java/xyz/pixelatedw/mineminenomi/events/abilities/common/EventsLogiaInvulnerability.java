package xyz.pixelatedw.mineminenomi.events.abilities.common;

import net.minecraft.enchantment.EnchantmentHelper;
import net.minecraft.entity.Entity;
import net.minecraft.entity.LivingEntity;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.entity.projectile.ArrowEntity;
import net.minecraft.item.ItemStack;
import net.minecraft.util.DamageSource;
import net.minecraftforge.event.entity.living.LivingAttackEvent;
import net.minecraftforge.event.entity.living.LivingEvent.LivingUpdateEvent;
import net.minecraftforge.eventbus.api.SubscribeEvent;
import net.minecraftforge.fml.common.Mod;
import xyz.pixelatedw.mineminenomi.Env;
import xyz.pixelatedw.mineminenomi.api.WyHelper;
import xyz.pixelatedw.mineminenomi.api.abilities.Ability;
import xyz.pixelatedw.mineminenomi.api.data.ability.AbilityDataCapability;
import xyz.pixelatedw.mineminenomi.api.data.ability.IAbilityData;
import xyz.pixelatedw.mineminenomi.config.CommonConfig;
import xyz.pixelatedw.mineminenomi.data.entity.devilfruit.DevilFruitCapability;
import xyz.pixelatedw.mineminenomi.data.entity.devilfruit.IDevilFruit;
import xyz.pixelatedw.mineminenomi.entities.abilityprojectiles.ExtraProjectiles.NormalBullet;
import xyz.pixelatedw.mineminenomi.entities.mobs.GenericNewEntity;
import xyz.pixelatedw.mineminenomi.helpers.DevilFruitsHelper;
import xyz.pixelatedw.mineminenomi.init.ModBlocks;
import xyz.pixelatedw.mineminenomi.init.ModEnchantments;
import xyz.pixelatedw.mineminenomi.init.ModWeapons;

@Mod.EventBusSubscriber(modid = Env.PROJECT_ID)
public class EventsLogiaInvulnerability
{
	@SubscribeEvent
	public static void onEntityAttackEvent(LivingAttackEvent event)
	{
		LivingEntity entity = event.getEntityLiving();
		DamageSource damageSource  = event.getSource();
		Entity sourceOfDamage = damageSource.getTrueSource();
		ItemStack heldItem = null;
		
		boolean entityIsLogia = false;
		String entityUsedFruit = "n/a";
		
		IAbilityData abilityDataProps;
		IDevilFruit devilFruitPropz;
		IDevilFruit devilFruitProps = DevilFruitCapability.get(entity);
		
		if(devilFruitProps != null)
		{
			entityIsLogia = devilFruitProps.isLogia();
			entityUsedFruit = devilFruitProps.getDevilFruit();
		}
		
		boolean attackerHasKairosekiWeapon = false;
		boolean attackerHasHaki = false;
		String attackerUsedFruit = "";
		
		if(sourceOfDamage instanceof PlayerEntity)
		{
			devilFruitPropz = DevilFruitCapability.get((LivingEntity) sourceOfDamage);
			abilityDataProps = AbilityDataCapability.get((LivingEntity) sourceOfDamage);
			Ability busoHaki = null;//abilityDataProps.getHotbarAbilityFromName(ModAttributes.BUSOSHOKU_HAKI.getAttributeName());
			boolean hasBusoHakiActive = (busoHaki != null && busoHaki.isPassiveActive());
			attackerHasHaki = hasBusoHakiActive;
			attackerUsedFruit = devilFruitPropz.getDevilFruit();
			heldItem = ((PlayerEntity) sourceOfDamage).getHeldItemMainhand();
			if(heldItem != null)
			{
				attackerHasKairosekiWeapon = heldItem.isEnchanted() && EnchantmentHelper.getEnchantmentLevel(ModEnchantments.KAIROSEKI, heldItem) > 0;	

				if(heldItem.getItem() == ModWeapons.jitte)
					attackerHasKairosekiWeapon = true;			
			}
		}
		else if(sourceOfDamage instanceof GenericNewEntity)
		{
			devilFruitPropz = DevilFruitCapability.get((LivingEntity) sourceOfDamage);
			abilityDataProps = AbilityDataCapability.get((LivingEntity) sourceOfDamage);
			Ability busoHaki = null;//abilityDataProps.getHotbarAbilityFromName(ModAttributes.BUSOSHOKU_HAKI.getAttributeName());
			boolean hasBusoHakiActive = (busoHaki != null && busoHaki.isPassiveActive());
			attackerHasHaki = hasBusoHakiActive;
			heldItem = ((GenericNewEntity) sourceOfDamage).getHeldItemMainhand();
			attackerUsedFruit = devilFruitPropz.getDevilFruit();
			//TODO Check if mobs have kairoseki weapons
			if(heldItem != null)
				attackerHasKairosekiWeapon = false;
		}

		if(sourceOfDamage instanceof LivingEntity)
		{
			if(entityIsLogia && !kairosekiChecks(entity) && !attackerHasHaki && !attackerHasKairosekiWeapon)
			{
				if(!CommonConfig.instance.isLogiaInvulnerabilityEnabled())
					return;
					
				if(entityUsedFruit.equalsIgnoreCase("gorogoro") && attackerUsedFruit.equalsIgnoreCase("gomugomu"))
					return;

				event.setCanceled(true);
				//ModNetwork.sendToAllAround(new SParticlesPacket("logiaEffect_" + entityUsedFruit, entity), entity);
			}
			else
			{
				if(sourceOfDamage instanceof PlayerEntity)
				{
					abilityDataProps = AbilityDataCapability.get((PlayerEntity) sourceOfDamage);
					
					if(!sourceOfDamage.world.isRemote && heldItem.isEmpty())
					{
						/*for(int i = 0; i < abilityDataProps.countAbilitiesInHotbar(); i++)
						{
							if(abilityDataProps.getHotbarAbilityFromSlot(i) != null && !abilityDataProps.getHotbarAbilityFromSlot(i).isOnCooldown() 
									&& abilityDataProps.getHotbarAbilityFromSlot(i).getAttribute().isPassive() && abilityDataProps.getHotbarAbilityFromSlot(i).isPassiveActive())
							{		
								if(abilityDataProps.getHotbarAbilityFromSlot(i).getAttribute().isPunch())
								{		
									abilityDataProps.getHotbarAbilityFromSlot(i).hitEntity((PlayerEntity) sourceOfDamage, entity);
								}
							}
						}*/
					}
				}
			}
		}
	
		if(entityIsLogia && CommonConfig.instance.isLogiaInvulnerabilityEnabled() && !kairosekiChecks(entity))
		{
			if(sourceOfDamage instanceof ArrowEntity)
				event.setCanceled(true);
			
			if(sourceOfDamage instanceof NormalBullet)
				event.setCanceled(true);
			
			if(damageSource.isExplosion())
				event.setCanceled(true);
		}

		if(entityUsedFruit.equalsIgnoreCase("meramera") && (damageSource.equals(DamageSource.IN_FIRE) || damageSource.equals(DamageSource.ON_FIRE)))
		{
			entity.extinguish();
			event.setCanceled(true);
		}
		
		if(entityUsedFruit.equalsIgnoreCase("magumagu") && (damageSource.equals(DamageSource.IN_FIRE) || damageSource.equals(DamageSource.ON_FIRE) || damageSource.equals(DamageSource.LAVA)))
		{
			entity.extinguish();
			event.setCanceled(true);
		}
	}
	
	@SubscribeEvent
	public static void onEntityUpdate(LivingUpdateEvent event)
	{
		if (!(event.getEntityLiving() instanceof LivingEntity))
			return;	
		
		LivingEntity player = event.getEntityLiving();
		IDevilFruit devilFruitProps = DevilFruitCapability.get(player);
		
		if (!devilFruitProps.isLogia())
			return;
				
		player.fallDistance = 0;
	}
	
	private static boolean kairosekiChecks(LivingEntity entity)
	{
		if(entity instanceof PlayerEntity)
		{
			PlayerEntity playerEntity = (PlayerEntity) entity;
			return DevilFruitsHelper.isNearbyKairoseki(playerEntity);
		}
		else
		{
			return WyHelper.isBlockNearby(entity, 3, ModBlocks.KAIROSEKI, ModBlocks.KAIROSEKI_ORE, ModBlocks.KAIROSEKI_BARS);
		}
	}
}
